<!-- üåê GLOBAL LOADER -->
@if (loading) {
  <div class="fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm z-9999">
    <div class="text-center animate-pulse">
      <fa-icon [icon]="icons.cogs" class="text-5xl text-white mb-2"></fa-icon>
      <p class="text-base font-semibold text-white">{{ globalLoadinText }}...</p>
    </div>
  </div>
}

<!-- üåê GLOBAL TOAST -->
@if (showMessage) {
  <div class="fixed inset-0 flex justify-center items-start z-99999 pointer-events-none">
    <div
      class="mt-6 px-5 py-3 rounded-xl shadow-xl text-white pointer-events-auto animate-fadeIn transition-all"
      [ngClass]="{
        'bg-green-600': messageType === 'success',
        'bg-red-600': messageType === 'error'
      }"
    >
      <fa-icon
        [icon]="messageType === 'success' ? icons.checkCircle : icons.exclamationCircle"
        class="mr-2"
      ></fa-icon>
      <span class="font-medium">{{ messageText }}</span>
    </div>
  </div>
}

<app-navbar />

<!-- BACKGROUND -->
<div class="fixed inset-0 -z-10">
  <img src="reviewBg.jpg" class="w-full h-full object-cover brightness-[0.35]" />
  <div class="absolute inset-0 bg-black/40"></div>
</div>

<section class="page-container py-10 px-6 max-w-5xl mx-auto text-gray-200 animate-fadeIn">

  <!-- BACK BUTTON -->
  <div class="mb-6">
    <a routerLink="/ourTrainers">
      <button class="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg shadow-lg hover:bg-orange-600 hover:scale-[1.05] active:scale-95 transition-all duration-200">
        <fa-icon [icon]="icons.leftArrow"></fa-icon>
        Back to Trainers
      </button>
    </a>
  </div>

  <!-- TRAINER HEADER -->
  <header class="mb-8 animate-slideInUp">
    <h1 class="text-4xl font-extrabold text-white drop-shadow-lg">
      {{ trainerModel.name }}
    </h1>

    <div class="flex flex-wrap gap-2 mt-3">
      @for (tag of trainerModel.specialities; track tag) {
        <span class="px-3 py-1 bg-blue-600/80 text-white text-xs font-semibold rounded-full shadow hover:bg-blue-700 transition">
          {{ tag }}
        </span>
      }
    </div>

    <div class="mt-2 flex items-center gap-4 text-sm text-gray-300">
      <div class="flex items-center gap-1">
        <fa-icon [icon]="icons.star" class="text-yellow-400"></fa-icon>
        <span>{{ trainerModel.rating | number : '1.1-1' }}</span>
      </div>
    </div>
  </header>

  <!-- SORT OPTION -->
  <div class="flex items-center justify-end mb-4 gap-2 animate-fadeIn">
    <button
      class="px-3 py-1 rounded-md bg-white/10 border border-white/20 text-gray-200 flex items-center gap-2 hover:bg-white/20 hover:scale-[1.03] transition"
      (click)="toggleSort()">
      <fa-icon [icon]="sortDirection === 'DESC' ? icons.arrowDown : icons.arrowUp"></fa-icon>
      {{ sortDirection === 'DESC' ? 'Newest First' : 'Oldest First' }}
    </button>
  </div>

  <!-- WRITE A REVIEW -->
  <section class="mb-12 animate-slideInUp delay-150">
    <div class="backdrop-blur-lg bg-white/10 border border-white/20 rounded-2xl p-6 shadow-xl">

      <h2 class="text-2xl font-bold text-white mb-1 flex items-center gap-2">
        ‚úçÔ∏è Write a Review
      </h2>

      <p class="text-gray-300 text-sm mb-4">Share your experience with {{ trainerModel.name }}</p>

      <!-- STAR RATING -->
      <div class="mb-6">
        <label class="text-sm text-gray-300 mb-1 block">Your Rating</label>
        <div class="flex gap-2">
          @for (star of [1,2,3,4,5]; track star) {
            <button
              class="text-3xl transition-all hover:scale-110"
              (click)="review = star"
              [ngClass]="{
                'text-yellow-400 scale-110 drop-shadow': review >= star,
                'text-gray-500': review < star
              }"
            >
              <fa-icon [icon]="icons.star"></fa-icon>
            </button>
          }
        </div>
      </div>

      <!-- COMMENT -->
      <textarea
        [(ngModel)]="comment"
        [attr.maxLength]="500"
        rows="4"
        class="w-full rounded-lg p-3 bg-black/30 border border-gray-500 text-gray-200 focus:ring-2 focus:ring-orange-500 transition"
      ></textarea>

      <!-- VALIDATION -->
      @if (comment.length > 500) {
        <p class="text-red-400 text-xs mt-1 animate-fadeIn">Maximum 500 characters allowed.</p>
      }

      <!-- BUTTONS -->
      <div class="flex gap-4 mt-4">
        <button
          (click)="addreview()"
          [disabled]="!isLoggedIn || loading || review === 0 || comment.trim() === '' || comment.length > 500"
          class="px-4 py-2 bg-orange-500 text-white rounded-lg shadow hover:bg-orange-600 hover:scale-[1.03] active:scale-95 transition disabled:opacity-40 disabled:cursor-not-allowed"
        >
          Submit Review
        </button>

        <button
          class="px-4 py-2 bg-gray-300/20 border border-white/20 text-gray-200 rounded-lg hover:bg-gray-400/30 active:scale-95 transition"
          (click)="review = 0; comment = ''">
          Reset
        </button>
      </div>
    </div>
  </section>

  <!-- REVIEW AREA -->
  <section class="animate-fadeIn">

    <h3 class="text-2xl font-semibold text-white mb-6">
      Reviews <span class="text-gray-400 text-sm">({{ totalElements }})</span>
    </h3>

    <!-- USER REVIEWS -->
    <div class="rounded-3xl p-6 mb-10 bg-white/5 border border-white/10 shadow-xl backdrop-blur-xl">
      <h4 class="text-xl font-semibold text-blue-200 mb-4 flex items-center gap-2">
        <span>Your Reviews</span>
        <span class="w-10 h-0.5 rounded bg-blue-300/40 block"></span>
      </h4>

      <div class="max-h-72 overflow-y-auto custom-scrollbar pr-2 space-y-4">

        @if (Userreviews.length > 0) {
          @for (ur of Userreviews; track ur.reviewId) {

            <div class="rounded-2xl p-5 bg-white/5 border border-white/10 shadow-lg hover:border-blue-300 hover:shadow-blue-500/30 transition">

              <!-- HEADER -->
              <div class="flex justify-between items-start">

                <div class="flex gap-3">
                  <div class="w-12 h-12 rounded-full text-white flex items-center justify-center text-lg font-bold shadow-lg"
                    [ngClass]="{
                      'bg-blue-500': ur.userRole === 'MEMBER',
                      'bg-orange-500': ur.userRole === 'TRAINER',
                      'bg-green-500': ur.userRole === 'ADMIN'
                    }">
                    {{ ur.userName[0] }}
                  </div>

                  <div>
                    <div class="font-semibold text-white">{{ ur.userName }}</div>
                    <div class="text-xs text-gray-400">{{ ur.reviewDate | date : 'mediumDate' }}</div>
                  </div>
                </div>

                <!-- STAR DISPLAY -->
                <div class="flex gap-1">
                  @for (i of [0,1,2,3,4]; track i) {
                    <fa-icon
                      [icon]="icons.star"
                      [ngClass]="{
                        'text-yellow-400': ur.review > i,
                        'text-gray-600': ur.review <= i
                      }"
                    ></fa-icon>
                  }
                </div>

              </div>

              <!-- UPDATE MODE -->
              @if (updateItem === ur.reviewId) {

                <!-- CURRENT RATING SMALL DISPLAY -->
                <div class="flex items-center gap-2 mt-4 text-gray-300">
                  <span class="text-xs opacity-80">Your Rating:</span>
                  <div class="flex gap-1">
                    @for (i of [0,1,2,3,4]; track i) {
                      <fa-icon
                        [icon]="icons.star"
                        class="text-sm"
                        [ngClass]="{
                          'text-yellow-400': updateReviewStar > i,
                          'text-gray-600': updateReviewStar <= i
                        }"
                      ></fa-icon>
                    }
                  </div>
                </div>

                <!-- EDITABLE STAR SELECTOR -->
                <div class="flex gap-2 mt-3">
                  @for (star of [1,2,3,4,5]; track star) {
                    <button
                      class="text-2xl transition-all hover:scale-125"
                      (click)="updateReviewStar = star"
                      [ngClass]="{
                        'text-yellow-400 scale-110': updateReviewStar >= star,
                        'text-gray-600': updateReviewStar < star
                      }"
                    >
                      <fa-icon [icon]="icons.star"></fa-icon>
                    </button>
                  }
                </div>

                <!-- COMMENT EDIT -->
                <textarea
                  [(ngModel)]="updateComment"
                  [attr.maxLength]="500"
                  rows="3"
                  class="w-full p-3 mt-4 rounded-lg bg-black/30 text-gray-200 border border-gray-600 focus:ring-2 focus:ring-blue-400 transition"
                ></textarea>

                @if (updateComment.length > 500) {
                  <p class="text-red-400 text-xs mt-1 animate-fadeIn">Maximum 500 characters allowed.</p>
                }

                <div class="mt-4 flex gap-3">
                  <button
                    class="px-4 py-1.5 bg-green-600 text-white rounded-md text-sm hover:bg-green-500 active:scale-95 transition"
                    (click)="confirmUpdate()"
                    [disabled]="updateReviewStar === 0 || updateComment.trim() === '' || updateComment.length > 500"
                  >
                    Save
                  </button>

                  <button
                    class="px-4 py-1.5 bg-gray-500 text-white rounded-md text-sm hover:bg-gray-600 active:scale-95 transition"
                    (click)="cancelUpdate()"
                  >
                    Cancel
                  </button>
                </div>

              } @else {

                <!-- COMMENT -->
                <p class="mt-3 text-gray-300">{{ ur.comment }}</p>

                <div class="flex gap-3 mt-3">
                  <button class="px-3 py-1 rounded-md text-sm flex items-center gap-1 bg-blue-600 text-white hover:bg-blue-500 transition"
                    (click)="update(ur)">
                    <fa-icon [icon]="icons.edit"></fa-icon> Edit
                  </button>

                  <button class="px-3 py-1 rounded-md text-sm flex items-center gap-1 bg-red-600 text-white hover:bg-red-500 transition"
                    (click)="showDeletePopup(ur)">
                    <fa-icon [icon]="icons.trash"></fa-icon> Delete
                  </button>
                </div>

              }

            </div>

          }
        } @else {
          <p class="text-gray-400 italic">You have not written any reviews yet.</p>
        }
      </div>

      <!-- USER PAGINATION -->
      <div class="mt-5 flex justify-center gap-4 text-gray-300">
        <button class="px-4 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-blue-400/20 hover:border-blue-300 transition disabled:opacity-30 disabled:cursor-not-allowed"
          (click)="goPreviousUserReview()" [disabled]="UserpageNo === 0">
          ‚Üê Prev
        </button>

        <span>Page {{ UserpageNo + 1 }}</span>

        <button class="px-4 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-blue-400/20 hover:border-blue-300 transition disabled:opacity-30 disabled:cursor-not-allowed"
          (click)="goNextUserReview()" [disabled]="UserlastPage">
          Next ‚Üí
        </button>
      </div>

    </div>

    <!-- ALL REVIEWS -->
    <div class="rounded-3xl p-6 bg-white/5 border border-white/10 shadow-xl backdrop-blur-xl">

      <h4 class="text-xl font-semibold text-orange-200 mb-4 flex items-center gap-2">
        <span>All Reviews</span>
        <span class="w-10 h-0.5 rounded bg-orange-300/40 block"></span>
      </h4>

      @if (reviews.length === 0) {
        <p class="text-gray-400 italic">No other reviews found.</p>
      }

      <div class="space-y-6">
        @for (r of reviews; track r.reviewId) {

          <div class="rounded-2xl p-5 bg-white/5 border border-white/10 shadow-lg hover:border-orange-300 hover:shadow-orange-500/30 transition">

            <!-- HEADER -->
            <div class="flex justify-between items-start">

              <div class="flex gap-3">
                <div class="w-12 h-12 rounded-full text-white flex items-center justify-center text-lg font-bold shadow-lg"
                  [ngClass]="{
                    'bg-blue-500': r.userRole === 'MEMBER',
                    'bg-orange-500': r.userRole === 'TRAINER',
                    'bg-green-500': r.userRole === 'ADMIN'
                  }">
                  {{ r.userName[0] }}
                </div>

                <div>
                  <div class="font-semibold text-white">{{ r.userName }}</div>
                  <div class="text-xs text-gray-400">{{ r.reviewDate | date : 'mediumDate' }}</div>
                </div>
              </div>

              <div class="text-right space-y-1">
                <div class="flex gap-1 justify-end">
                  @for (i of [0,1,2,3,4]; track i) {
                    <fa-icon [icon]="icons.star"
                      [ngClass]="{
                        'text-yellow-400': r.review > i,
                        'text-gray-600': r.review <= i
                      }"></fa-icon>
                  }
                </div>

                @if (userRole === 'ADMIN' || userRole === 'TRAINER') {
  <button
    class="text-xs text-red-400 hover:text-red-300 transition flex items-center gap-1"
    (click)="showDeletePopup(r)"
  >
    <fa-icon [icon]="icons.trash"></fa-icon>
    Delete
  </button>
}

<button
  class="text-xs text-orange-300 hover:text-orange-200 transition flex items-center gap-1"
  (click)="openReportPopup(r.reviewId)"
>
  <fa-icon [icon]="icons.warning"></fa-icon>
  Report
</button>

              </div>
            </div>

            <p class="mt-3 text-gray-300">{{ r.comment }}</p>

          </div>

        }
      </div>

      <!-- GLOBAL PAGINATION -->
      <div class="mt-8 flex justify-center gap-4 text-gray-300">
        <button class="px-4 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-orange-400/20 hover:border-orange-300 transition disabled:opacity-30 disabled:cursor-not-allowed"
          (click)="goPrevious()" [disabled]="pageNo === 0">
          ‚Üê Prev
        </button>

        <span>Page {{ pageNo + 1 }}</span>

        <button class="px-4 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-orange-400/20 hover:border-orange-300 transition disabled:opacity-30 disabled:cursor-not-allowed"
          (click)="goNext()"
          [disabled]="lastPage">
          Next ‚Üí
        </button>
      </div>

      
    </div>

  </section>
</section>

<app-footer />


@if (showDeletePopUp && deleteItem) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeIn">

    <div class="bg-[#1a1f2b] text-slate-200 w-[90%] sm:w-[380px] rounded-xl p-6 shadow-2xl border border-slate-700 animate-popIn">

      <!-- Header -->
      <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
        <fa-icon [icon]="icons.exclamationCircle" class="text-red-500 text-xl"></fa-icon>
        Confirm Delete
      </h3>

      <!-- Message -->
      <p class="text-sm leading-relaxed">
        are you sure you want to delete this review? by 
        <span class="font-semibold text-red-400">{{ deleteItem.userName }}</span>
        
      </p>

      <!-- ‚≠ê Dynamic Stars (MUST be outside <p>) -->
      <div class="flex items-center gap-1 my-4">
        @for (star of getStars(deleteItem.review); track $index) {
          <fa-icon [icon]="icons.star" class="text-yellow-400 text-base"></fa-icon>
        }
      </div>

      <p class="text-red-500 font-medium mb-6">
        This action cannot be undone.
      </p>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 text-sm">

        <button
          class="px-4 py-2 rounded-md bg-red-700 hover:bg-red-600 text-white flex items-center gap-2 transition"
          (click)="confirmDelete()">
          <fa-icon [icon]="icons.trash"></fa-icon>
          Delete
        </button>

        <button
          class="px-4 py-2 rounded-md bg-slate-600 hover:bg-slate-500 text-white transition"
          (click)="closeDeletePopup()">
          Cancel
        </button>

      </div>

    </div>
  </div>
}


