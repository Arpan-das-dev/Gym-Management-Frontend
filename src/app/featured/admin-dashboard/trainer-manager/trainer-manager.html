<app-navbar />

<!-- BACKGROUND -->
<div class="fixed inset-0 -z-10">
  <img
    src="allMembersBg.jpg"
    alt="background"
    class="w-full h-full object-cover brightness-90"
  />
  <div class="absolute inset-0 bg-black/20 pointer-events-none"></div>
</div>

<section class="page-container py-10">
  <!-- GLOBAL LOADER -->
  @if (loading) {
  <div class="fixed inset-0 flex items-center justify-center bg-black/50 z-50">
    <div class="text-center animate-pulse">
      <fa-icon [icon]="icons.cogs" class="text-5xl mb-2"></fa-icon>
      <p class="text-base font-semibold">
        {{ messageText || "Processing..." }}
      </p>
    </div>
  </div>
  }

  <!-- TOAST MESSAGE -->
  @if (showMessage) {
  <div
    class="toast"
    [ngClass]="{
      'toast-success': messageType === 'success',
      'toast-error': messageType === 'error'
    }"
  >
    <fa-icon
      [icon]="
        messageType === 'success' ? icons.checkCircle : icons.exclamationCircle
      "
    ></fa-icon>
    <span class="ml-2">{{ messageText }}</span>
  </div>
  }

  <!-- ACTION BAR -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-white">Trainer Management</h2>

    <button
      class="glass-button px-4 py-2 rounded-lg flex items-center gap-2"
      (click)="fetchAllTrainers()"
    >
      <fa-icon [icon]="icons.refresh"></fa-icon>
      Load Trainers
    </button>
  </div>

  <!-- TRAINERS GRID -->
  <main class="cards-wrapper">
    <div>
      @for (t of trainers; track t.id) {
      <article class="glass-card group">
        <!-- CARD HEADER -->
        <div class="card-top flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="avatar-wrapper relative">
              <span
                class="status-dot"
                [ngClass]="
                  isActive(t.id).active ? 'bg-green-500' : 'bg-orange-500'
                "
              ></span>

              <img
                [src]="mapProfileImage(t.imageUrl, t.gender)"
                alt="avatar"
                class="avatar"
              />
            </div>

            <div>
              <h3 class="name">{{ t.firstName }} {{ t.lastName }}</h3>
              <p class="text-sm text-slate-200/70">
                {{ isActive(t.id).status }}
              </p>
            </div>
          </div>

          <!-- ACTION BUTTONS -->
          <div class="flex gap-2">
            <button
              class="icon-btn"
              (click)="showDetails(t.id)"
              title="View Details"
            >
              <fa-icon [icon]="t.show ? icons.eyeSlash : icons.eye"></fa-icon>
            </button>

            <button
              class="icon-btn"
              (click)="openMailPopup(t)"
              title="Send Mail"
            >
              <fa-icon [icon]="icons.mail"></fa-icon>
            </button>

            <button
              class="icon-btn"
              (click)="openFreezePopup(t.id, !t.frozen)"
              title="Freeze / Unfreeze"
            >
              <fa-icon
                [icon]="t.frozen ? icons.unFreeze : icons.freeze"
              ></fa-icon>
            </button>

            <button
              class="icon-btn danger"
              (click)="openDeletPopup(t.id)"
              title="Delete Trainer"
            >
              <fa-icon [icon]="icons.delete"></fa-icon>
            </button>
            <button
                class="icon-btn"
                (click)="toggleClientView(t)"
              >
                <fa-icon [icon]="icons.clients"></fa-icon>
              </button>
          </div>
          
         
        </div>

        <!-- CARD BODY -->
        @if (t.show) {
        <div class="card-body mt-4">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <!-- ABOUT (FULL WIDTH) -->
            <div class="col-span-2 flex gap-2 items-start">
              <fa-icon
                [icon]="icons.eye"
                class="mt-1 text-orange-400"
              ></fa-icon>
              <div>
                <span class="label block mb-1">About</span>
                <p class="text-slate-200/80 leading-relaxed">
                  {{ t.about || "No description provided." }}
                </p>
              </div>
            </div>

            <!-- EMAIL -->
            <div class="flex gap-2 items-center">
              <fa-icon [icon]="icons.mail" class="text-blue-400"></fa-icon>
              <span><span class="label">Email:</span> {{ t.email }}</span>
            </div>

            <!-- PHONE -->
            <div class="flex gap-2 items-center">
              <fa-icon [icon]="icons.phone" class="text-green-400"></fa-icon>
              <span><span class="label">Phone:</span> {{ t.phone }}</span>
            </div>

            <!-- GENDER -->
            <div class="flex gap-2 items-center">
              <fa-icon
                [icon]="t.gender === 'FEMALE' ? icons.female : icons.male"
                [ngClass]="
                  t.gender === 'FEMALE' ? 'text-pink-400' : 'text-blue-400'
                "
              ></fa-icon>
              <span><span class="label">Gender:</span> {{ t.gender }}</span>
            </div>

            <!-- TRAINER ID -->
            <div class="flex gap-2 items-center">
              <fa-icon [icon]="icons.id" class="text-purple-400"></fa-icon>
              <span><span class="label">Trainer ID:</span> {{ t.id }}</span>
            </div>

            <!-- RATING (STARS) -->
            <div class="flex gap-2 items-center col-span-2">
              <fa-icon [icon]="icons.star" class="text-yellow-400"></fa-icon>

              <div class="flex items-center gap-1">
                <!-- FULL STARS -->
                @for (i of getFullStars(t.averageRating); track $index) {
                <fa-icon [icon]="icons.star" class="text-yellow-400"></fa-icon>
                }

                <!-- HALF STAR -->
                @if (hasHalfStar(t.averageRating)) {
                <fa-icon
                  [icon]="icons.star"
                  class="text-yellow-400 opacity-50"
                ></fa-icon>
                }

                <!-- RATING NUMBER -->
                <span class="ml-2 text-slate-300 text-xs">
                  ({{ t.averageRating.toFixed(1) || "0.0" }})
                </span>
              </div>
            </div>

            <!-- CLIENT COUNT -->
            <div class="flex gap-2 items-center">
              <fa-icon [icon]="icons.clients" class="text-cyan-400"></fa-icon>
              <span
                ><span class="label">Clients:</span>
                {{ t.clientCount || 0 }}</span
              >
            </div>

            <!-- FROZEN STATUS -->
            <div class="flex gap-2 items-center">
              <fa-icon
                [icon]="t.frozen ? icons.freeze : icons.unFreeze"
                [ngClass]="t.frozen ? 'text-red-400' : 'text-green-400'"
              ></fa-icon>
              <span>
                <span class="label">Frozen:</span>
                {{ t.frozen ? "Yes" : "No" }}
              </span>
            </div>
          </div>
        </div>
        }
         <!-- CLIENT LIST SECTION -->
          @if (t.clientViewMode) {
          <div class="card-body mt-6 border-t border-white/10 pt-4">
            <h4
              class="text-sm font-semibold text-white mb-3 flex items-center gap-2"
            >
              <fa-icon [icon]="icons.clients" class="text-cyan-400"></fa-icon>
              Assigned Clients ({{ getClients(t.id).length }})
            </h4>

            @if (getClients(t.id).length === 0) {
            <p class="text-xs text-slate-400">
              No clients assigned to this trainer.
            </p>
            } @if (getClients(t.id).length > 0) {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              @for (c of getClients(t.id); track c.memberId) {
              <div
                class="glass-input rounded-xl p-4 flex items-center justify-between"
              >
                <!-- CLIENT INFO -->
                <div class="flex items-center gap-3">
                  <span
                    class="w-2 h-2 rounded-full"
                    [ngClass]="
                      isMemberActive(c.memberId)
                        ? 'bg-green-500'
                        : 'bg-orange-500'
                    "
                  ></span>

                  <img
                    [src]="c.memberProfileImageUrl || 'defaultProfile.png'"
                    class="w-10 h-10 rounded-full object-cover"
                  />

                  <div>
                    <p class="text-sm font-medium text-white">
                      {{ c.memberName }}
                    </p>
                    <p class="text-xs text-white">
                      Ends: {{ c.eligibilityEnd }}
                    </p>
                  </div>
                </div>

                <!-- CLIENT ACTION -->
                <button
                  class="icon-btn danger"
                  title="Remove Client"
                  (click)="openDeleteClientPopup(t, c)"
                >
                  <fa-icon [icon]="icons.delete"></fa-icon>
                </button>
              </div>
              }
            </div>
            }
          </div>
          }
      </article>
      }
      
    </div>
  </main>
  <!-- DELETE CLIENT POPUP -->
  @if (deleteClentPopup) {
  <div class="modal-backdrop">
    <div class="modal glass-input">
      <h2 class="text-lg font-semibold text-red-400">Remove Client</h2>

      <p class="text-sm mt-2">
        Are you sure you want to remove
        <strong>{{ memberToDelete.memberName }}</strong>
        from
        <strong>
          {{ trainerOfMember.firstName }}
          {{ trainerOfMember.lastName }} </strong
        >?
      </p>

      <div class="flex justify-end gap-3 mt-4">
        <button
          class="glass-button-secondary"
          (click)="closeDeleteClientPopup()"
        >
          Cancel
        </button>

        <button class="glass-button danger" (click)="deleteCilentForTrainer()">
          Remove
        </button>
      </div>
    </div>
  </div>
  }

  <!-- FREEZE CONFIRM POPUP -->
  @if (showFreezePopup) {
  <div class="modal-backdrop">
    <div class="modal glass-input">
      <h2 class="text-lg font-semibold">
        {{ freeze ? "Freeze Trainer" : "Unfreeze Trainer" }}
      </h2>

      <p class="text-sm mt-2">
        Are you sure you want to
        <strong>{{ freeze ? "freeze" : "unfreeze" }}</strong>
        this trainer?
      </p>

      <div class="flex justify-end gap-3 mt-4">
        <button class="glass-button-secondary" (click)="closeFreezePopup()">
          Cancel
        </button>
        <button class="glass-button" (click)="freezeOrUnFreeze()">
          Confirm
        </button>
      </div>
    </div>
  </div>
  }

  <!-- DELETE CONFIRM POPUP -->
  @if (showDeletePopup) {
  <div class="modal-backdrop">
    <div class="modal glass-input">
      <h2 class="text-lg font-semibold text-red-400">Delete Trainer</h2>

      <p class="text-sm mt-2">
        This action is <strong>permanent</strong>. Do you want to continue?
      </p>

      <div class="flex justify-end gap-3 mt-4">
        <button class="glass-button-secondary" (click)="closeDeletePopup()">
          Cancel
        </button>
        <button class="glass-button danger" (click)="deleteTrainer()">
          Delete
        </button>
      </div>
    </div>
  </div>
  }

  <!-- MAIL POPUP -->
  @if (mailPopupOpen) {
  <div class="modal-backdrop">
    <div class="modal glass-input">
      <h2 class="text-lg font-semibold text-white">Send Mail</h2>

      <p class="text-sm">
        To:
        {{ selectedTrainer.firstName }}
        {{ selectedTrainer.lastName }}
        â€” {{ selectedTrainer.email }}
      </p>

      <input
        type="text"
        class="w-full px-3 py-2 rounded-lg mt-3"
        placeholder="Subject"
        [(ngModel)]="mailSubject"
      />

      <textarea
        class="w-full px-3 py-2 rounded-lg h-28 mt-2"
        placeholder="Message"
        [(ngModel)]="mailMessage"
      ></textarea>

      <div class="flex justify-end gap-3 mt-4">
        <button class="glass-button-secondary" (click)="closeMailPopup()">
          Cancel
        </button>
        <button class="glass-button" (click)="sendMail()">Send</button>
      </div>
    </div>
  </div>
  }
</section>

<app-footer />
